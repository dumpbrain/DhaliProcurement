@model DhaliProcurement.ViewModel.DemoVM
@{
    ViewBag.Title = "Project Procurement";
}


<div class="row">
    <div class="col-md-12">
        <!-- Basic layout-->
        <div class="panel panel-flat">
            <div class="panel-heading">
                <h5 class="panel-title"><i class="icon-stack-plus position-left"></i>Create New Project Information Costing</h5><hr />
                <div class="heading-elements">
                    <ul class="icons-list">
                        <li><a data-action="collapse"></a></li>
                    </ul>
                </div>
            </div>
            <div class="panel-body">
                @using (Html.BeginForm())
                {

                    <table class="table">
                        <tr>
                            <td>Project Name</td>
                            <td>

                                @Html.DropDownList("ProjectId", null, "--Select--", htmlAttributes: new { @id = "ProjectId", @class = "form-control select2", @style = "width: 500px !important" })
                                @Html.ValidationMessage("ProjectId", "", new { @class = "text-danger" })

                            </td>
                            <td>Project Start Date</td>
                            <td>
                                @Html.TextBox("projStartDate", "", new { @class = "form-control", disabled = "true" })

                            </td>
                        </tr>
                        <tr>
                            <td>Site Name</td>
                            <td>
                                @Html.DropDownList("SiteId", null, "--Select--", htmlAttributes: new { @id = "SiteId", @class = "form-control select2", @style = "width: 500px !important" })
                                @Html.ValidationMessage("SiteId", "", new { @class = "text-danger" })
                            </td>
                            <td>Project End Date</td>
                            <td>
                                @Html.TextBox("projEndDate", "", new { @class = "form-control", disabled = "true" })
                            </td>
                        </tr>

                        <tr>
                            <td>Site Engineer</td>
                            <td>
                                @Html.TextBox("SiteEngineer", null, new { @class = "form-control", disabled = "true" })
                            </td>

                        </tr>

                        <tr>
                            <td>Project Manager</td>
                            <td>
                                @Html.TextBox("ProjectManager", null, new { @class = "form-control", disabled = "true" })
                            </td>
                        </tr>


                        <tr>
                            <td>BOQ Date</td>
                            <td>
                                @Html.TextBox("BOQDate", null, new { @class = "form-control datepicker" })
                            </td>

                            <td>BOQ No</td>
                            <td>
                                @Html.TextBox("BOQNo", null, new { @class = "form-control" })
                            </td>
                        </tr>


                        <tr>
                            <td>NOA Date</td>
                            <td>
                                @Html.TextBox("NOADate", null, new { @class = "form-control datepicker" })
                            </td>

                            <td>NOA No</td>
                            <td>
                                @Html.TextBox("NOANo", null, new { @class = "form-control" })
                            </td>

                        </tr>
                        <tr>
                            <td>Project Type</td>
                            <td>
                                @Html.DropDownList("ProjectType", null, "Select", new { @class = "form-control select2" })
                            </td>
                            <td>Status</td>
                            <td>
                                @Html.TextBox("ProjectStatus", null, new { @class = "form-control" })
                            </td>
                        </tr>

                        <tr>
                            <td>Remarks</td>
                            <td>
                                @Html.TextBox("ProjectRemarks", "", new { @class = "form-control" })
                            </td>

                        </tr>

                    </table>
                    <hr />

                }

                @*<p>
                        <button type="button" class="btn btn-primary btn-xs add-newRow"><i class="icon-add position-left"></i> Add</button>
                    </p>*@

                @*<div class="table-responsive">
                        <table class="table table-xxs table-bordered Task-list" id="TaskTable">
                            <thead>
                                <tr class="bg-blue">

                                    <th class="col-lg-1">SL No</th>
                                    <th class="col-lg-3">Item Name</th>
                                    <th class="col-lg-2">Quantity</th>
                                    <th class="col-lg-2">Unit</th>
                                    <th class="col-lg-1">Costing</th>
                                    <th class="col-lg-1">Remarks</th>
                                    <th class="col-lg-2">&nbsp;</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>*@






                <div class="details well" style=" border 1px solid black;">
                    <h4>Project Procurement Items</h4>
                    <table style="width: 100%;">
                        <tr>
                            <td style="font-size: 15px; font-weight: bold;">Item Name</td>
                            <td style="font-size: 15px; font-weight: bold;">Qty</td>
                            <td style="font-size: 15px; font-weight: bold;">Unit</td>
                            <td style="font-size: 15px; font-weight: bold;">Costing</td>
                            <td style="font-size: 15px; font-weight: bold;">Remarks</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>



                            <td>

                                @Html.DropDownList("ItemName", null, "Select item", htmlAttributes: new { @class = "form-control select2", @data_required = "required", @id = "ItemName", @style = "width: 150px;" })
                                @*<span class="error">Item name required</span>*@
                            </td>
                            <td>
                                <input type="text" id="Qty" class="form-control" value=""/>
                                @*<span class="error">Valid quantity required</span>*@
                            </td>
                            <td>
                                @Html.DropDownList("Unit", null, "Select unit", htmlAttributes: new { @class = "form-control select2", @data_required = "required", @style = "width: 150px;" })
                                @*<span class="error">Unit required</span>*@
                            </td>
                            <td>
                                <input type="text" id="Cost" class="form-control" />
                                @*<span class="error">Valid rate required</span>*@
                            </td>
                            <td>
                                <input type="text" id="ItemRemarks" class="form-control" />
                                @*<span class="error">Item remarks required</span>*@
                            </td>
                            <td>
                                <input type="button" id="addNewRow" value="+" class="btn btn-primary" style ="background-color: grey;border: none;"/>

                            </td>
                        </tr>
                        <tr>
                            <td><span class="error" id="ItemName_Error">Item name required</span></td>
                            <td><span class="error" id="Quantity_Error">Quantity required</span></td>
                            <td><span class="error" id="UnitName_Error">Unit required</span></td>
                            <td><span class="error" id="Costing_Error">Costing required</span></td>
                            <td></td>

                        </tr>

                    </table>
                    <br />
                    <table class="Resource-list table table-bordered" id="Item-list">
                        <tr class="bg-grey">
                            <th>Item Name</th>
                            <th>Qty</th>
                            <th>Unit</th>
                            <th>Costing</th>
                            <th>Remarks</th>
                            <th></th>
                        </tr>


                        <tfoot>
                            <tr>
                                <td></td>
                                <td></td>
                                <td>Total Costing</td>
                                <td><input type="text" value="" id="totalCost" class="form-control" disabled="disabled" /></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tfoot>

                    </table>

                </div>

            </div>



        </div>


    </div>
    <div class="form-group">
        <div class="col-md-12" style="text-align:center;">
            @*<button type="button" id="SaveItem" class="btn btn-success" style ="background-color: grey;border: none;"><i class="icon-floppy-disk position-left"></i>  Create</button>*@
            <button type="button" id="SaveItem" class="btn btn-primary"><i class="icon-floppy-disk position-left"></i>  Create</button>
        </div>
    </div>
</div>



<script>
    var counter = 0; //counter for the serial

    //add new row
    $('#addNewRow').click(function (event) {

        event.preventDefault();
        counter++;
        var ItemId = $('#ItemName option:selected').val();
        var ItemName = $('#ItemName option:selected').text();
        var Qty = $('#Qty').val();
        var Unit = $('#Unit option:selected').text();
        var UnitId = $('#Unit option:selected').val();
        var Cost = $('#Cost').val();
        var ItemRemarks = $('#ItemRemarks').val();

        //new
        var isValidItem = true;

        if ($('#ItemName').val().trim() == '') {
            $('#ItemName_Error').show();
            isValidItem = false;
            //$('#ItemName').siblings('span.error').css('visibility', 'visible');
        }
        else {
            $('#ItemName_Error').hide();
        }

        if (!($('#Qty').val().trim() != '' && !isNaN($('#Qty').val().trim()))) {
            isValidItem = false;
            $('#Quantity_Error').show();
        }
        else {
            $('#Quantity_Error').hide();

        }

        if ($('#Unit').val().trim() == '') {
            isValidItem = false;
            $('#UnitName_Error').show();
        }
        else {
            $('#UnitName_Error').hide();

        }

        if (!($('#Cost').val().trim() != '' && !isNaN($('#Cost').val().trim()))) {
            isValidItem = false;
            $('#Costing_Error').show();
        }
        else {
            $('#Costing_Error').hide();

        }

        $('table.Resource-list tr').each(function () {
            var name = $(this).find("td input[name=ItemName]").val();
            //alert(name);
            if (ItemName == name) {
                alert('This item already exists!');
                isValidItem = false;
            }

        });

        //Add item to list if valid
        if (isValidItem) {

            var newRow = jQuery('<tr>'
                + '<td> <input value="' + ItemId + '" type="hidden" name="ItemId"/> <input class="form-control" value="' + ItemName + '" readonly="true" type="text" name="ItemName"/></td>'
                + '<td><input class="form-control" value="' + Qty + '" type="text" name="Quantity"/></td>'
                + '<td><input value="' + UnitId + '" type="hidden" name="UnitId"/><input class="form-control" value="' + Unit + '" " readonly="true" type="text" name="ItemUnit"/></td>'
                + '<td><input class="form-control" value="' + Cost + '"  type="text" name="ItemCost' +
              '"/></td><td><input class="form-control" value="' + ItemRemarks + '" type="text" name="ItemRemarks' +
             '"/></td> <td> <button type="button" class="btn text-warning-600 btn-flat btn-icon btn-rounded" value="Delete" onclick="$(this).parent().parent().remove();"><i class="icon-cross"></i></button></td></tr>');

            jQuery('table.Resource-list').append(newRow);
            totalItemCost();
            //$('#ItemName').text("");

        }
        //end
        $('#Qty').val("");
        $('#Cost').val("");
        $('#ItemRemarks').val("");

    });




    $('#Item-list').on({
        'change': function () {
            var ItemTotalCost = 0;
            for (var cn = 1; cn < $('#Item-list tr').length - 1; cn++) {
              //  var quantity = $('#Item-list tr').eq(cn).find("td input[name=Quantity]").val();
               // console.log('Quantity: ' + quantity);
                var cost = $('#Item-list tr').eq(cn).find("td input[name=ItemCost]").val();
                // console.log('Cost: ' + cost);
                //alert(cost);
                var result = 0;
                if (isNaN(cost) || cost=="") {
                    
                    result = parseFloat(0);
                }
                else {
                    result = parseFloat(cost);
                }
                
                ItemTotalCost = parseFloat(ItemTotalCost + result);
            }

            $('#totalCost').val(ItemTotalCost);

        }
    });



    function totalItemCost() {

        var ItemTotalCost = 0;
        for (var cn = 1; cn < $('#Item-list tr').length - 1; cn++) {
          //  var quantity = $('#Item-list tr').eq(cn).find("td input[name=Quantity]").val();
          //  console.log('Quantity: ' + quantity);
            var cost = $('#Item-list tr').eq(cn).find("td input[name=ItemCost]").val();
          //  console.log('Cost: ' + cost);
            var result =  parseFloat(cost);
            ItemTotalCost = parseFloat(ItemTotalCost + result);
        }

        $('#totalCost').val(ItemTotalCost);

    }


    $(document).ready(function () {
        $('#SiteId').attr("disabled", "true");

        $('#ItemName_Error').hide();
        $('#Quantity_Error').hide();
        $('#UnitName_Error').hide();
        $('#Costing_Error').hide();

    });

    $('#ProjectId').change(function () {

        var id = $('#ProjectId option:selected').val();

        $.ajax({
            url: "/ProcProjects/GetPId",
            type: "post",
            data: {
                ProjectId: id
            },
            dataType: "json",
            success: function (data) {
                $('#SiteId').removeAttr("disabled");
                $('#projStartDate').val(data.start);
                $('#projEndDate').val(data.end);
                $('#ProjectManager').val(data.manager);
                var listOfSites = data.Sites.length;

                var sites = "<select id='sites'>";
                sites = sites + '<option value="">--Select--</option>';
                for (var i = 0; i < listOfSites; i++) {
                    sites = sites + '<option value=' + data.Sites[i].Value + '>' + data.Sites[i].Text + '</option>';
                }
                sites = sites + '</select>';
                $('#SiteId').html(sites);

            },
            error: function (xhr) {
                alert('error');
            }
        });
    });

    $("#SiteId").change(function () {
        var SiteId = $('#SiteId').val();
        $.ajax({
            type: "post",
            url: "/ProcProjects/GetSiteEngineer",
            data: { SiteId },
            datatype: "json",
            traditional: true,
            success: function (data) {
                $('#SiteEngineer').val(data.siteEngineer);
            }

        });
    });


    $('#SaveItem').click(function (e) {

        if ($('#ProjectId option:selected').text() === "--Select--") {
            alert('Please select Project');
            $('#ProjectId option:selected').focus();

        }
        else if ($.trim($('#SiteId').val()) === "") {
            alert('SiteId required');
            $('#SiteId').focus();
        }
        //else if ($.trim($('#Cost').val()) === "") {
        //    alert('Cost required');
        //    $('#Cost').focus();
        //}
        else {
            CreateProjectItem();
        }

    });


    function CreateProjectItem() {
        debugger;
        var Projectid = $('#ProjectId option:selected').val();
        var ProjectSiteId = $('#SiteId option:selected').val();
        var BOQDate = $('#BOQDate').val();
        var BOQNo = $('#BOQNo').val();
        var NOADate = $('#NOADate').val();
        var NOANo = $('#NOANo').val();
        var ProjectType = $('#ProjectType').val();
        var ProjectStatus = $('#ProjectStatus').val();
        var ProjectRemarks = $('#ProjectRemarks ').val();

        var ItemId = document.getElementsByName("ItemId");
        //for (var i = 0; i < ItemId.length;i++){
        //    alert('ItemId '+ItemId[i].value);
        //}

        var UnitId = document.getElementsByName("UnitId");


        var Qty = document.getElementsByName("Quantity");


        var Unit = document.getElementsByName("ItemUnit");


        var Cost = document.getElementsByName("ItemCost");

        var ItemRemarks = document.getElementsByName("ItemRemarks");


        var Length = $('.Resource-list tr').length;
       // alert(Length);
        var ItemDetails = [];

        for (var i = 0; i < Length - 2; i++) {

            ItemDetails.push({ ItemISLNO: ItemId[i].value, PQuantity: Qty[i].value, UnitUSLNO: UnitId[i].value, PCost: Cost[i].value, Remarks: ItemRemarks[i].value, ProjectSiteId: ProjectSiteId });
            console.log('<----->');
                console.log('Item:' + ItemDetails[i].ItemISLNO);
                console.log('Qty:' + ItemDetails[i].PQuantity);
                console.log('Unit:' + ItemDetails[i].UnitUSLNO);
                console.log('Cost:' + ItemDetails[i].PCost);
                console.log('Qty:' + ItemDetails[i].Remarks);
             //   console.log('PId:' + ItemDetails[i].ProjectId);
                console.log('SId:' + ItemDetails[i].ProjectSiteId);
        }

        //for (var i = 0; i < Length - 1; i++) {
        //    console.log('Item:' + ItemDetails[i].ItemISLNO);
        //    console.log('Qty:' + ItemDetails[i].PQuantity);
        //    console.log('Unit:' + ItemDetails[i].UnitUSLNO);
        //    console.log('Cost:' + ItemDetails[i].PCost);
        //    console.log('Qty:' + ItemDetails[i].Remarks);
        //    console.log('PId:' + ItemDetails[i].ProjectId);
        //    console.log('SId:' + ItemDetails[i].ProjectSiteId);

        //    console.log('<----->');
        //}

        //ResourceDetails = JSON.stringify({ 'ItemDetails': ItemDetails, 'ProjectId': Projectid.value });



        ResourceDetails = JSON.stringify({
            ResourceDetails: ItemDetails,
            //ProjectId: Projectid,
            ProjectSiteId: ProjectSiteId,
            BOQDate: BOQDate,
            BOQNo: BOQNo,
            NOADate:NOADate,
            NOANo: NOANo,
            ProjectType: ProjectType,
            ProjectStatus: ProjectStatus,
            ProjectRemarks:ProjectRemarks
        });
        //data: '{"ResourceDetails":"' + ItemDetails + '"}',
        //{ 'ItemDetails': ItemDetails, 'ProjectId': Projectid.value },
        //debugger
        $.ajax({
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            type: 'POST',
            url: '/ProcProjects/ItemCreate',
            traditional: true,
            data: ResourceDetails,
            success: function (result) {
                //alert('Successful');
                if (result.flag) {
                    alert("Record save successfully!");
                    window.location = "/ProcProjects/Index";

                }
                else {
                    alert(result.message);
                }
            },
            failure: function (response) {
                alert('Error');
            }
        });


    };

    $('#save').click(function () {
        var Pid = $('#ProjectId option:selected').val();
        var sid = $('#SiteId  option:selected').val();

        $.ajax({
            url: "/ProcProjects/SaveProject",
            type: "post",
            data: {
                ProjectId: Pid,
                SiteId: sid
            },
            dataType: "json",
            success: function (data) {
                alert('Project Create successful');

            },
            error: function (xhr) {
                alert('error');
            }
        });

    });




</script>



@section Scripts {


    @Scripts.Render("~/bundles/jqueryval")

    <script src="~/Plugins/select2/select2.min.js"></script>
    <script>
      $(".select2").select2();
      //$(".datepicker").datepicker();


      $('.datepicker').datepicker({
          format: 'dd/mm/yyyy',
          todayHighlight: true,
          todayBtn: true,
          autoclose: true
      });

    </script>

}



<style>
    /*.scrolling {
        width: 100%;
        height: 350px;
        /*border: 13px solid #bed5cd;
        overflow-x: scroll;
        overflow-y: scroll;
    }*/
    span.error {
        display: block;
        /*visibility: hidden;*/
        color: red;
        font-size: 90%;
    }
</style>